import subprocess

EXEC = "./practica2SG"
MAP_DIR = "mapas"

tests = [

    # Tests nivel 1
    ("mapa30.map", [0, 0, 17, 5, 0, 17, 17, 0, 3, 3, 0], None),
    ("mapa30.map", [0, 0, 24, 7, 2, 17, 17, 0, 3, 3, 0], None),
    ("mapa30.map", [0, 0, 24, 10, 2, 17, 17, 0, 3, 3, 0], None),
    ("mapa30.map", [0, 0, 16, 9, 2, 16, 14, 6, 3, 3, 0], None),
    ("mapa75.map", [0, 0, 10, 18, 2, 42, 30, 6, 3, 3, 0], None),
    ("gemini2.map", [0, 0, 3, 10, 2, 3, 13, 6, 3, 3, 0], None),
    ("paldea25.map", [1, 0, 76, 15, 6, 22, 68, 2, 3, 3, 0], None),
    ("chess.map", [1, 0, 45, 4, 0, 45, 14, 0, 3, 3, 0], None),
    ("luminalia25.map", [1, 0, 28, 14, 3, 27, 84, 5, 3, 3, 0], None),
    ("bosque_prohibido.map", [1, 0, 24, 5, 4, 12, 7, 4, 3, 3, 0], None),
    ("islas25.map", [1, 0, 11, 3, 2, 12, 3, 2, 3, 3, 0], None),

    # Tests nivel 2
    ("mapa30.map", [1, 2, 11, 4, 4, 26, 26, 0, 3, 4, 0], 2989),
    ("mapa30.map", [1, 2, 24, 9, 4, 26, 26, 0, 20, 9, 0], 2979),
    ("mapa30.map", [1, 2, 24, 13, 0, 26, 26, 0, 25, 17, 0], 2983),
    ("mapa50.map", [1, 2, 40, 16, 6, 46, 27, 2, 27, 3, 0], 2737),
    ("luminalia25.map", [1, 2, 32, 74, 6, 5, 96, 0, 32, 75, 0], 2962),
    ("luminalia25.map", [1, 2, 80, 58, 6, 5, 96, 0, 20, 48, 0], 2926),
    ("paldea25.map", [1, 2, 91, 45, 2, 96, 96, 0, 30, 57, 0], 2913),
    ("paldea25.map", [1, 2, 53, 85, 6, 96, 96, 0, 49, 4, 0], 2757),
    ("chess.map", [1, 2, 25, 24, 0, 46, 46, 3, 24, 24, 0], 2951),
    ("chess.map", [1, 2, 27, 27, 0, 46, 46, 3, 26, 27, 0], 2954),
    ("luminalia25.map", [1, 2, 59, 89, 2, 5, 96, 0, 29, 15, 0], 2914),
    ("scape25.map", [1, 2, 7, 8, 0, 15, 8, 5, 22, 8, 0], 2949),
    ("scape25.map", [1, 2, 7, 8, 0, 15, 8, 5, 22, 15, 0], 2955),
    ("scape25.map", [1, 2, 7, 8, 0, 15, 8, 5, 22, 21, 0], 2961),
    ("scape25.map", [1, 2, 7, 14, 0, 15, 8, 5, 22, 8, 0], 2939),
    ("scape25.map", [1, 2, 7, 14, 0, 15, 8, 5, 22, 15, 0], 2945),
    ("scape25.map", [1, 2, 7, 14, 0, 15, 8, 5, 22, 21, 0], 2951),
    ("scape25.map", [1, 2, 7, 21, 0, 15, 8, 5, 22, 8, 0], 2929),
    ("scape25.map", [1, 2, 7, 21, 0, 15, 8, 5, 22, 15, 0], 2935),
    ("scape25.map", [1, 2, 7, 21, 0, 15, 8, 5, 22, 21, 0], 2941),
    ("scape25.map", [1, 2, 7, 8, 2, 15, 8, 5, 22, 8, 0], 2951),

    # Tests nivel 3
    ("mapa30.map", [1, 3, 7, 7, 2, 11, 6, 4, 12, 5, 0], 2975),
    ("mapa30.map", [1, 3, 5, 5, 2, 10, 10, 4, 12, 5, 0], 2592),
    ("mapa30.map", [1, 3, 26, 26, 0, 11, 4, 4, 3, 4, 0], 2979),
    ("mapa30.map", [1, 3, 26, 26, 0, 24, 9, 4, 20, 9, 0], 2961),
    ("mapa50.map", [1, 3, 46, 27, 0, 20, 8, 2, 18, 12, 0], 2642),
    ("mapa50.map", [1, 3, 46, 27, 2, 40, 16, 6, 27, 3, 0], 2621),
    ("luminalia25.map", [1, 3, 5, 96, 0, 32, 74, 6, 32, 75, 0], 2828),
    ("luminalia25.map", [1, 3, 5, 96, 0, 80, 58, 6, 20, 48, 0], 2782),
    ("paldea25.map", [1, 3, 96, 96, 0, 91, 45, 2, 30, 57, 0], 2846),
    ("paldea25.map", [1, 3, 96, 96, 0, 53, 85, 6, 49, 4, 0], 2571),
    ("chess.map", [1, 3, 46, 46, 3, 25, 24, 0, 24, 24, 0], 2925),
    ("chess.map", [1, 3, 46, 46, 3, 27, 27, 0, 26, 27, 0], 2934),
    ("luminalia25.map", [1, 3, 5, 96, 0, 59, 89, 2, 29, 15, 0], 2659),
    ("scape25.map", [1, 3, 15, 8, 5, 22, 21, 4, 7, 8, 0], 2816),
    ("scape25.map", [1, 3, 15, 8, 5, 22, 21, 4, 7, 14, 0], 2694),
    ("scape25.map", [1, 3, 15, 8, 5, 22, 21, 4, 7, 21, 0], 2670),
    ("scape25.map", [1, 3, 15, 8, 5, 22, 21, 6, 7, 21, 0], 2672),
    ("scape25.map", [1, 3, 15, 8, 5, 22, 15, 4, 7, 8, 0], 2670),
    ("scape25.map", [1, 3, 15, 8, 5, 22, 15, 4, 7, 14, 0], 2758),
    ("scape25.map", [1, 3, 15, 8, 5, 22, 15, 4, 7, 21, 0], 2753),
    ("scape25.map", [1, 3, 15, 8, 5, 22, 8, 4, 7, 8, 0], 2643),
    ("scape25.map", [1, 3, 15, 8, 5, 22, 8, 4, 7, 14, 0], 2753),
    ("scape25.map", [1, 3, 15, 8, 5, 22, 8, 4, 7, 21, 0], 2753),

    ("mapas/mapa30.map", ["1", "4", "4", "4", "6", "12", "12", "2", "7", "8", "0", "16", "6", "0", "26", "9", "1", "25", "16", "0", "3", "3", "0", "5", "10", "0", "16", "14", "0", "19", "10", "0", "21", "4", "1", "7", "4", "0", "24", "4", "0", "12", "3", "0", "6", "15", "0", "25", "18", "0", "8", "19", "0", "14", "14", "0", "23", "15", "1", "26", "8", "0", "10", "24", "1", "19", "26", "1", "25", "7", "0", "16", "11", "0", "22", "15", "1", "20", "15", "1", "22", "19", "1", "10", "20", "0", "4", "13", "0", "26", "24", "1", "9", "6", "0", "26", "10", "0", "17", "19", "1", "25", "13", "0", "24", "20", "1", "25", "19", "1", "12", "18", "1", "8", "23", "0", "9", "13", "1", "6", "5", "0", "8", "16", "1", "12", "5", "0", "3", "14", "1", "11", "22", "1", "11", "8", "0", "5", "17", "0", "7", "4", "0", "21", "3", "0", "23", "4", "1", "15", "5", "0", "7", "23", "0", "21", "19", "0", "4", "15", "1", "6", "13", "1", "23", "17", "1", "6", "26", "1", "5", "4", "0", "24", "10", "1", "16", "17", "1", "13", "20", "0", "21", "9", "1", "26", "22", "0", "22", "24", "0", "14", "4", "0", "24", "26", "0", "7", "18", "1", "6", "21", "1", "9", "9", "1", "18", "6", "0", "19", "15", "1", "16", "21", "0", "3", "14", "0", "12", "10", "0", "25", "13", "1", "17", "24", "1", "6", "20", "1", "14", "14", "0", "9", "21", "0", "5", "18", "1", "20", "20", "0", "19", "10", "1", "5", "18", "1", "18", "21", "1", "9", "22", "0", "20", "19", "1", "7", "15", "0", "26", "20", "0", "10", "17", "1", "17", "19", "1", "8", "23", "1", "8", "9", "1", "9", "5", "0", "20", "3", "0", "19", "11", "1", "6", "23", "0", "16", "8", "0", "26", "14", "0", "17", "4", "0", "8", "25", "0", "14", "13", "1", "25", "14", "0", "8", "5", "1", "20", "21", "1", "4", "18", "1", "14", "25", "1"], None),
    ("mapas/mapa50.map", ["1", "4", "28", "25", "4", "28", "20", "2", "36", "23", "0", "39", "8", "0", "46", "26", "1", "39", "34", "0", "26", "37", "0", "18", "46", "0", "3", "46", "0", "3", "3", "0", "10", "17", "1", "39", "45", "0", "9", "16", "0", "38", "13", "0", "27", "23", "0", "31", "18", "0", "45", "31", "0", "35", "7", "0", "12", "6", "1", "40", "7", "0", "20", "6", "1", "10", "25", "1", "41", "30", "0", "14", "31", "0", "26", "24", "1", "38", "26", "1", "38", "20", "1", "44", "14", "0", "17", "40", "0", "45", "3", "1", "4", "9", "0", "33", "44", "0", "17", "3", "1", "3", "11", "0", "42", "13", "1", "26", "18", "1", "38", "25", "1", "33", "26", "0", "46", "46", "1", "36", "14", "0", "36", "31", "1", "17", "34", "0", "8", "22", "1", "44", "41", "1", "16", "11", "0", "44", "17", "0", "29", "32", "0", "42", "21", "0", "46", "19", "1", "40", "34", "0", "45", "24", "0", "46", "7", "0", "44", "32", "1", "21", "30", "1", "14", "39", "1", "15", "22", "1", "11", "9", "0", "13", "27", "1", "20", "8", "1", "45", "5", "0"], None)
]   



def parse_battery(output: str):
    for line in output.splitlines():
        if "Coste de Energía" in line:
            try:
                gasto = int(line.split(":")[1])
                return 3000 - gasto
            except ValueError:
                return None
    return None

def color_text(text, color_code):
    return f"\033[{color_code}m{text}\033[0m"

def check_base_messages(output: str):
    rescatador_ok = "El rescatador ha alcanzado un puesto base." in output
    auxiliar_ok = "El auxiliar ha alcanzado un puesto base." in output
    return rescatador_ok, auxiliar_ok

def run_test(map_name, params, expected_battery):
    result = subprocess.run(
        [EXEC, f"{MAP_DIR}/{map_name}"] + list(map(str, params)),
        capture_output=True,
        text=True
    )

    if result.returncode != 0:
        return (False, map_name, params, f"Error: {result.stderr.strip()}")

    level = params[1]
    if level == 0:
        rescatador_ok, auxiliar_ok = check_base_messages(result.stdout)
        if rescatador_ok and auxiliar_ok:
            return (True, map_name, None, "Bases alcanzadas")
        else:
            missing = []
            if not rescatador_ok:
                missing.append("Rescatador")
            if not auxiliar_ok:
                missing.append("Auxiliar")
            return (False, map_name, params, f"No alcanzado: {', '.join(missing)}")

    battery = parse_battery(result.stdout)
    if battery == expected_battery:
        return (True, map_name, None, battery)
    else:
        return (False, map_name, params, battery)

if __name__ == "__main__":
    total = len(tests)
    ok = 0
    failed_tests = []

    current_level = None
    for test in tests:
        level = test[1][1]
        if level != current_level:
            current_level = level
            print(f"\n{color_text(f'Tests nivel {level}:', '34')}")

        success, map_name, params, info = run_test(*test)
        if success:
            print(color_text(f"✅ {map_name}", "32"))
            ok += 1
        else:
            if isinstance(info, str) and "Error" in info:
                print(color_text(f"❌ {map_name} {' '.join(map(str, params))}", "31"))
                print(color_text(f"   {info}", "31"))
            else:
                expected = test[2]
                print(color_text(f"❌ {map_name} {' '.join(map(str, params))}", "31"))
                print(color_text(f"   batería final = {info} (esperado {expected})", "31"))
            failed_tests.append((map_name, params))

    print("=" * 40)
    print(f"Total: {total} | OK: {ok} | Fails: {total - ok}")
    if failed_tests:
        print(color_text("\nTests fallidos:", "31"))
        for map_name, params in failed_tests:
            print(f"{EXEC} {MAP_DIR}/{map_name} {' '.join(map(str, params))}")
